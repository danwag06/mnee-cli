!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@bsv/sdk")):"function"==typeof define&&define.amd?define(["exports","@bsv/sdk"],r):r((t||self).sigmaProtocol={},t.bsv)}(this,function(t,r){function i(){return i=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var e in i)({}).hasOwnProperty.call(i,e)&&(t[e]=i[e])}return t},i.apply(null,arguments)}function e(t){var r=function(t){if("object"!=typeof t||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof r?r:r+""}var n=r.BSM.magicHash,o=r.Utils.toHex,s="5349474d41";t.Algorithm=void 0,(t.Algorithm||(t.Algorithm={})).BSM="BSM";var a=/*#__PURE__*/function(){function a(t,i,e,n){var o=this;void 0===i&&(i=0),void 0===e&&(e=0),void 0===n&&(n=0),this._inputHash=null,this._dataHash=null,this._transaction=void 0,this._sigmaInstance=void 0,this._refVin=void 0,this._targetVout=void 0,this._sig=void 0,this.setHashes=function(){o._inputHash=o.getInputHash(),o._dataHash=o.getDataHash()},this.setTargetVout=function(t){o._targetVout=t},this.setSigmaInstance=function(t){o._sigmaInstance=t},this.verify=function(){if(!o.sig)throw new Error("No signature data provided");var t=o.getMessageHash();if(!t)throw new Error("No tx data provided");var i=r.Signature.fromCompact(o.sig.signature,"base64");return-1!==u(i,t,o.sig.address)},this.getInputHash=function(){return o._getInputHashByVin(-1===o._refVin?o._targetVout:o._refVin)},this._getInputHashByVin=function(t){var i=o._transaction.inputs[t];if(null!=i&&i.sourceTXID){var e=Buffer.alloc(36),n=Buffer.from(i.sourceTXID,"hex");return e.set(n,0),e.writeUInt32LE(i.sourceOutputIndex,32),r.Hash.sha256(Array.from(e))}return r.Hash.sha256(Array.from(new Uint8Array(32)))},this.getDataHash=function(){var t;if(!o._transaction)throw new Error("No transaction provided");for(var i=null==(t=o._transaction)?void 0:t.outputs[o._targetVout].lockingScript,e=(null==i?void 0:i.toASM().split(" "))||[],n=0,a=0;a<e.length;a++)if(e[a].toUpperCase()===s.toUpperCase()){if(n===o._sigmaInstance){var u=e.slice(0,a-1),h=r.Script.fromASM(u.join(" "));return r.Hash.sha256(h.toBinary())}n++}var c=r.Script.fromASM(e.join(" "));return r.Hash.sha256(c.toBinary())},this._transaction=t,this._targetVout=i,this._refVin=n,this._sigmaInstance=e,this._sig=this.sig,this.setHashes()}var h,c,f=a.prototype;return f.getMessageHash=function(){if(!this._inputHash||!this._dataHash)throw new Error("Input hash and data hash must be set");var t=this._inputHash,i=this._dataHash,e=new Uint8Array(t.length+i.length);return e.set(t,0),e.set(i,t.length),r.Hash.sha256(Array.from(e))},f._sign=function(e,n,o){var a,u,h,c=-1===this._refVin?this._targetVout:this._refVin;if(void 0===o)throw new Error("Failed recovery missing");var f=s+" "+Buffer.from(t.Algorithm.BSM,"utf-8").toString("hex")+" "+Buffer.from(n,"utf-8").toString("hex")+" "+e.toCompact(o,!0,"hex")+" "+Buffer.from(c.toString(),"utf-8").toString("hex"),g=r.Script.fromASM(f);this._sig={algorithm:t.Algorithm.BSM,address:n,signature:e.toCompact(o,!0,"base64"),vin:c,targetVout:this._targetVout};var l=null==(a=this.targetTxOut)?void 0:a.lockingScript.toASM(),p=(null==(u=l)?void 0:u.split(" ").includes("OP_RETURN"))?"7c":"OP_RETURN";if(this.sig&&this._sigmaInstance===this.getSigInstanceCount()){var v,d=(null==(v=l)?void 0:v.split(" "))||[],m=this.getSigInstancePosition(),_=f.split(" ");-1!==m&&(l=d.splice.apply(d,[m,5].concat(_)).join(""))}var y=r.Script.fromASM(l+" "+p+" "+f),S=new r.Transaction(this._transaction.version,this._transaction.inputs.map(function(t){return i({},t)}),this._transaction.outputs.map(function(t){return i({},t)})),b={satoshis:null==(h=this.targetTxOut)?void 0:h.satoshis,lockingScript:y};return S.outputs[this._targetVout]=b,this._transaction=S,i({sigmaScript:g,signedTx:S},this._sig)},f.sign=function(t){var i=this.getMessageHash(),e=r.BSM.sign(i,t,"raw"),o=t.toAddress(),s=new r.BigNumber(n(i)),a=e.CalculateRecoveryFactor(t.toPublicKey(),s);return this._sign(e,o,a)},f.remoteSign=function(t,e){try{var n,s=this,a=e?((n={})[e.key]=e.value,n):{},u=t+"/sign"+("query"===(null==e?void 0:e.type)?"?"+(null==e?void 0:e.key)+"="+(null==e?void 0:e.value):""),h={message:o(s.getMessageHash()),encoding:"hex"};return Promise.resolve(function(t,e){try{var n=Promise.resolve(fetch(u,{method:"POST",headers:i({},a,{"Content-Type":"application/json",Accept:"application/json"}),body:JSON.stringify(h)})).then(function(t){function i(i){return Promise.resolve(t.json()).then(function(t){var i=t.address,e=t.recovery,n=r.Signature.fromCompact(t.sig,"base64");return s._sign(n,i,e)})}var e=function(){if(!t.ok)return Promise.resolve(t.text()).then(function(r){throw console.error("Response Error:",r),new Error("HTTP Error: "+t.status)})}();return e&&e.then?e.then(i):i()})}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}(0,function(t){throw console.error("Fetch Error:",t),t}))}catch(t){return Promise.reject(t)}},f.getSigInstanceCount=function(){var t,r=null==(t=this.targetTxOut)?void 0:t.lockingScript.toASM();return((null==r?void 0:r.split(" "))||[]).filter(function(t){return t.toUpperCase()===s.toUpperCase()}).length},f.getSigInstancePosition=function(){var t,r=null==(t=this.targetTxOut)?void 0:t.lockingScript.toASM();return((null==r?void 0:r.split(" "))||[]).findIndex(function(t){return t.toUpperCase()===s.toUpperCase()})},h=a,(c=[{key:"transaction",get:function(){return this._transaction}},{key:"targetTxOut",get:function(){return this._transaction.outputs[this._targetVout]||null}},{key:"sig",get:function(){for(var t=this._transaction.outputs[this._targetVout],r=null==t?void 0:t.lockingScript,i=(null==r?void 0:r.toASM().split(" "))||[],e=[],n=0;n<i.length;n++)if(i[n].toUpperCase()===s.toUpperCase()){var o={algorithm:Buffer.from(i[n+1],"hex").toString("utf-8"),address:Buffer.from(i[n+2],"hex").toString("utf-8"),signature:Buffer.from(i[n+3],"hex").toString("base64"),vin:Number.parseInt(Buffer.from(i[n+4],"hex").toString("utf-8"))};e.push(o),n+=4}return 0===e.length?this._sig:e[this._sigmaInstance]}}])&&function(t,r){for(var i=0;i<r.length;i++){var n=r[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,e(n.key),n)}}(h.prototype,c),Object.defineProperty(h,"prototype",{writable:!1}),h}(),u=function(t,i,e){for(var o=0;o<4;o++)try{var s=t.RecoverPublicKey(o,new r.BigNumber(n(i)));if(r.BSM.verify(i,t,s)&&s.toAddress()===e)return o}catch(t){}return-1};t.Sigma=a,t.sigmaHex=s});
//# sourceMappingURL=index.umd.js.map
