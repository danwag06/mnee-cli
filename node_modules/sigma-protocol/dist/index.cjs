var t=require("@bsv/sdk");function r(){return r=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var e in i)({}).hasOwnProperty.call(i,e)&&(t[e]=i[e])}return t},r.apply(null,arguments)}function i(t){var r=function(t){if("object"!=typeof t||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof r?r:r+""}var e=t.BSM.magicHash,n=t.Utils.toHex,o="5349474d41";exports.Algorithm=void 0,(exports.Algorithm||(exports.Algorithm={})).BSM="BSM";var s=/*#__PURE__*/function(){function s(r,i,e,n){var s=this;void 0===i&&(i=0),void 0===e&&(e=0),void 0===n&&(n=0),this._inputHash=null,this._dataHash=null,this._transaction=void 0,this._sigmaInstance=void 0,this._refVin=void 0,this._targetVout=void 0,this._sig=void 0,this.setHashes=function(){s._inputHash=s.getInputHash(),s._dataHash=s.getDataHash()},this.setTargetVout=function(t){s._targetVout=t},this.setSigmaInstance=function(t){s._sigmaInstance=t},this.verify=function(){if(!s.sig)throw new Error("No signature data provided");var r=s.getMessageHash();if(!r)throw new Error("No tx data provided");var i=t.Signature.fromCompact(s.sig.signature,"base64");return-1!==a(i,r,s.sig.address)},this.getInputHash=function(){return s._getInputHashByVin(-1===s._refVin?s._targetVout:s._refVin)},this._getInputHashByVin=function(r){var i=s._transaction.inputs[r];if(null!=i&&i.sourceTXID){var e=Buffer.alloc(36),n=Buffer.from(i.sourceTXID,"hex");return e.set(n,0),e.writeUInt32LE(i.sourceOutputIndex,32),t.Hash.sha256(Array.from(e))}return t.Hash.sha256(Array.from(new Uint8Array(32)))},this.getDataHash=function(){var r;if(!s._transaction)throw new Error("No transaction provided");for(var i=null==(r=s._transaction)?void 0:r.outputs[s._targetVout].lockingScript,e=(null==i?void 0:i.toASM().split(" "))||[],n=0,a=0;a<e.length;a++)if(e[a].toUpperCase()===o.toUpperCase()){if(n===s._sigmaInstance){var u=e.slice(0,a-1),h=t.Script.fromASM(u.join(" "));return t.Hash.sha256(h.toBinary())}n++}var c=t.Script.fromASM(e.join(" "));return t.Hash.sha256(c.toBinary())},this._transaction=r,this._targetVout=i,this._refVin=n,this._sigmaInstance=e,this._sig=this.sig,this.setHashes()}var u,h,c=s.prototype;return c.getMessageHash=function(){if(!this._inputHash||!this._dataHash)throw new Error("Input hash and data hash must be set");var r=this._inputHash,i=this._dataHash,e=new Uint8Array(r.length+i.length);return e.set(r,0),e.set(i,r.length),t.Hash.sha256(Array.from(e))},c._sign=function(i,e,n){var s,a,u,h=-1===this._refVin?this._targetVout:this._refVin;if(void 0===n)throw new Error("Failed recovery missing");var c=o+" "+Buffer.from(exports.Algorithm.BSM,"utf-8").toString("hex")+" "+Buffer.from(e,"utf-8").toString("hex")+" "+i.toCompact(n,!0,"hex")+" "+Buffer.from(h.toString(),"utf-8").toString("hex"),g=t.Script.fromASM(c);this._sig={algorithm:exports.Algorithm.BSM,address:e,signature:i.toCompact(n,!0,"base64"),vin:h,targetVout:this._targetVout};var f=null==(s=this.targetTxOut)?void 0:s.lockingScript.toASM(),l=(null==(a=f)?void 0:a.split(" ").includes("OP_RETURN"))?"7c":"OP_RETURN";if(this.sig&&this._sigmaInstance===this.getSigInstanceCount()){var p,v=(null==(p=f)?void 0:p.split(" "))||[],d=this.getSigInstancePosition(),m=c.split(" ");-1!==d&&(f=v.splice.apply(v,[d,5].concat(m)).join(""))}var _=t.Script.fromASM(f+" "+l+" "+c),S=new t.Transaction(this._transaction.version,this._transaction.inputs.map(function(t){return r({},t)}),this._transaction.outputs.map(function(t){return r({},t)})),y={satoshis:null==(u=this.targetTxOut)?void 0:u.satoshis,lockingScript:_};return S.outputs[this._targetVout]=y,this._transaction=S,r({sigmaScript:g,signedTx:S},this._sig)},c.sign=function(r){var i=this.getMessageHash(),n=t.BSM.sign(i,r,"raw"),o=r.toAddress(),s=new t.BigNumber(e(i)),a=n.CalculateRecoveryFactor(r.toPublicKey(),s);return this._sign(n,o,a)},c.remoteSign=function(i,e){try{var o,s=this,a=e?((o={})[e.key]=e.value,o):{},u=i+"/sign"+("query"===(null==e?void 0:e.type)?"?"+(null==e?void 0:e.key)+"="+(null==e?void 0:e.value):""),h={message:n(s.getMessageHash()),encoding:"hex"};return Promise.resolve(function(i,e){try{var n=Promise.resolve(fetch(u,{method:"POST",headers:r({},a,{"Content-Type":"application/json",Accept:"application/json"}),body:JSON.stringify(h)})).then(function(r){function i(i){return Promise.resolve(r.json()).then(function(r){var i=r.address,e=r.recovery,n=t.Signature.fromCompact(r.sig,"base64");return s._sign(n,i,e)})}var e=function(){if(!r.ok)return Promise.resolve(r.text()).then(function(t){throw console.error("Response Error:",t),new Error("HTTP Error: "+r.status)})}();return e&&e.then?e.then(i):i()})}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}(0,function(t){throw console.error("Fetch Error:",t),t}))}catch(t){return Promise.reject(t)}},c.getSigInstanceCount=function(){var t,r=null==(t=this.targetTxOut)?void 0:t.lockingScript.toASM();return((null==r?void 0:r.split(" "))||[]).filter(function(t){return t.toUpperCase()===o.toUpperCase()}).length},c.getSigInstancePosition=function(){var t,r=null==(t=this.targetTxOut)?void 0:t.lockingScript.toASM();return((null==r?void 0:r.split(" "))||[]).findIndex(function(t){return t.toUpperCase()===o.toUpperCase()})},u=s,(h=[{key:"transaction",get:function(){return this._transaction}},{key:"targetTxOut",get:function(){return this._transaction.outputs[this._targetVout]||null}},{key:"sig",get:function(){for(var t=this._transaction.outputs[this._targetVout],r=null==t?void 0:t.lockingScript,i=(null==r?void 0:r.toASM().split(" "))||[],e=[],n=0;n<i.length;n++)if(i[n].toUpperCase()===o.toUpperCase()){var s={algorithm:Buffer.from(i[n+1],"hex").toString("utf-8"),address:Buffer.from(i[n+2],"hex").toString("utf-8"),signature:Buffer.from(i[n+3],"hex").toString("base64"),vin:Number.parseInt(Buffer.from(i[n+4],"hex").toString("utf-8"))};e.push(s),n+=4}return 0===e.length?this._sig:e[this._sigmaInstance]}}])&&function(t,r){for(var e=0;e<r.length;e++){var n=r[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,i(n.key),n)}}(u.prototype,h),Object.defineProperty(u,"prototype",{writable:!1}),u}(),a=function(r,i,n){for(var o=0;o<4;o++)try{var s=r.RecoverPublicKey(o,new t.BigNumber(e(i)));if(t.BSM.verify(i,r,s)&&s.toAddress()===n)return o}catch(t){}return-1};exports.Sigma=s,exports.sigmaHex=o;
//# sourceMappingURL=index.cjs.map
