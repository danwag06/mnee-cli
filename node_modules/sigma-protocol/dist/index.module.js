import{Hash as t,Script as r,Transaction as n,BSM as e,BigNumber as i,Signature as o,Utils as s}from"@bsv/sdk";function a(){return a=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var e in n)({}).hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t},a.apply(null,arguments)}function u(t){var r=function(t){if("object"!=typeof t||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof r?r:r+""}var h,c=e.magicHash,f=s.toHex,g="5349474d41";!function(t){t.BSM="BSM"}(h||(h={}));var l=/*#__PURE__*/function(){function s(n,e,i,s){var a=this;void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),this._inputHash=null,this._dataHash=null,this._transaction=void 0,this._sigmaInstance=void 0,this._refVin=void 0,this._targetVout=void 0,this._sig=void 0,this.setHashes=function(){a._inputHash=a.getInputHash(),a._dataHash=a.getDataHash()},this.setTargetVout=function(t){a._targetVout=t},this.setSigmaInstance=function(t){a._sigmaInstance=t},this.verify=function(){if(!a.sig)throw new Error("No signature data provided");var t=a.getMessageHash();if(!t)throw new Error("No tx data provided");var r=o.fromCompact(a.sig.signature,"base64");return-1!==p(r,t,a.sig.address)},this.getInputHash=function(){return a._getInputHashByVin(-1===a._refVin?a._targetVout:a._refVin)},this._getInputHashByVin=function(r){var n=a._transaction.inputs[r];if(null!=n&&n.sourceTXID){var e=Buffer.alloc(36),i=Buffer.from(n.sourceTXID,"hex");return e.set(i,0),e.writeUInt32LE(n.sourceOutputIndex,32),t.sha256(Array.from(e))}return t.sha256(Array.from(new Uint8Array(32)))},this.getDataHash=function(){var n;if(!a._transaction)throw new Error("No transaction provided");for(var e=null==(n=a._transaction)?void 0:n.outputs[a._targetVout].lockingScript,i=(null==e?void 0:e.toASM().split(" "))||[],o=0,s=0;s<i.length;s++)if(i[s].toUpperCase()===g.toUpperCase()){if(o===a._sigmaInstance){var u=i.slice(0,s-1),h=r.fromASM(u.join(" "));return t.sha256(h.toBinary())}o++}var c=r.fromASM(i.join(" "));return t.sha256(c.toBinary())},this._transaction=n,this._targetVout=e,this._refVin=s,this._sigmaInstance=i,this._sig=this.sig,this.setHashes()}var l,v,d=s.prototype;return d.getMessageHash=function(){if(!this._inputHash||!this._dataHash)throw new Error("Input hash and data hash must be set");var r=this._inputHash,n=this._dataHash,e=new Uint8Array(r.length+n.length);return e.set(r,0),e.set(n,r.length),t.sha256(Array.from(e))},d._sign=function(t,e,i){var o,s,u,c=-1===this._refVin?this._targetVout:this._refVin;if(void 0===i)throw new Error("Failed recovery missing");var f=g+" "+Buffer.from(h.BSM,"utf-8").toString("hex")+" "+Buffer.from(e,"utf-8").toString("hex")+" "+t.toCompact(i,!0,"hex")+" "+Buffer.from(c.toString(),"utf-8").toString("hex"),l=r.fromASM(f);this._sig={algorithm:h.BSM,address:e,signature:t.toCompact(i,!0,"base64"),vin:c,targetVout:this._targetVout};var p=null==(o=this.targetTxOut)?void 0:o.lockingScript.toASM(),v=(null==(s=p)?void 0:s.split(" ").includes("OP_RETURN"))?"7c":"OP_RETURN";if(this.sig&&this._sigmaInstance===this.getSigInstanceCount()){var d,m=(null==(d=p)?void 0:d.split(" "))||[],_=this.getSigInstancePosition(),y=f.split(" ");-1!==_&&(p=m.splice.apply(m,[_,5].concat(y)).join(""))}var S=r.fromASM(p+" "+v+" "+f),w=new n(this._transaction.version,this._transaction.inputs.map(function(t){return a({},t)}),this._transaction.outputs.map(function(t){return a({},t)})),b={satoshis:null==(u=this.targetTxOut)?void 0:u.satoshis,lockingScript:S};return w.outputs[this._targetVout]=b,this._transaction=w,a({sigmaScript:l,signedTx:w},this._sig)},d.sign=function(t){var r=this.getMessageHash(),n=e.sign(r,t,"raw"),o=t.toAddress(),s=new i(c(r)),a=n.CalculateRecoveryFactor(t.toPublicKey(),s);return this._sign(n,o,a)},d.remoteSign=function(t,r){try{var n,e=this,i=r?((n={})[r.key]=r.value,n):{},s=t+"/sign"+("query"===(null==r?void 0:r.type)?"?"+(null==r?void 0:r.key)+"="+(null==r?void 0:r.value):""),u={message:f(e.getMessageHash()),encoding:"hex"};return Promise.resolve(function(t,r){try{var n=Promise.resolve(fetch(s,{method:"POST",headers:a({},i,{"Content-Type":"application/json",Accept:"application/json"}),body:JSON.stringify(u)})).then(function(t){function r(r){return Promise.resolve(t.json()).then(function(t){var r=t.address,n=t.recovery,i=o.fromCompact(t.sig,"base64");return e._sign(i,r,n)})}var n=function(){if(!t.ok)return Promise.resolve(t.text()).then(function(r){throw console.error("Response Error:",r),new Error("HTTP Error: "+t.status)})}();return n&&n.then?n.then(r):r()})}catch(t){return r(t)}return n&&n.then?n.then(void 0,r):n}(0,function(t){throw console.error("Fetch Error:",t),t}))}catch(t){return Promise.reject(t)}},d.getSigInstanceCount=function(){var t,r=null==(t=this.targetTxOut)?void 0:t.lockingScript.toASM();return((null==r?void 0:r.split(" "))||[]).filter(function(t){return t.toUpperCase()===g.toUpperCase()}).length},d.getSigInstancePosition=function(){var t,r=null==(t=this.targetTxOut)?void 0:t.lockingScript.toASM();return((null==r?void 0:r.split(" "))||[]).findIndex(function(t){return t.toUpperCase()===g.toUpperCase()})},l=s,(v=[{key:"transaction",get:function(){return this._transaction}},{key:"targetTxOut",get:function(){return this._transaction.outputs[this._targetVout]||null}},{key:"sig",get:function(){for(var t=this._transaction.outputs[this._targetVout],r=null==t?void 0:t.lockingScript,n=(null==r?void 0:r.toASM().split(" "))||[],e=[],i=0;i<n.length;i++)if(n[i].toUpperCase()===g.toUpperCase()){var o={algorithm:Buffer.from(n[i+1],"hex").toString("utf-8"),address:Buffer.from(n[i+2],"hex").toString("utf-8"),signature:Buffer.from(n[i+3],"hex").toString("base64"),vin:Number.parseInt(Buffer.from(n[i+4],"hex").toString("utf-8"))};e.push(o),i+=4}return 0===e.length?this._sig:e[this._sigmaInstance]}}])&&function(t,r){for(var n=0;n<r.length;n++){var e=r[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,u(e.key),e)}}(l.prototype,v),Object.defineProperty(l,"prototype",{writable:!1}),l}(),p=function(t,r,n){for(var o=0;o<4;o++)try{var s=t.RecoverPublicKey(o,new i(c(r)));if(e.verify(r,t,s)&&s.toAddress()===n)return o}catch(t){}return-1};export{h as Algorithm,l as Sigma,g as sigmaHex};
//# sourceMappingURL=index.module.js.map
