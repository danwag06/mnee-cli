var t=require("@bsv/sdk"),r=require("satoshi-token"),e=require("sigma-protocol"),n=require("image-meta");function o(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,n=Array(r);e<r;e++)n[e]=t[e];return n}function i(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,r){if(t){if("string"==typeof t)return o(t,r);var e={}.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?o(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function s(){return s=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var n in e)({}).hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},s.apply(null,arguments)}function a(t,r){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},a(t,r)}var u,c,f,d,l=function(t){return Buffer.from(t).toString("hex")},h="1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5",p=10,v="https://ordinals.gorillapool.io/api",y=/*#__PURE__*/function(r){function e(){return r.apply(this,arguments)||this}var n,o;return o=r,(n=e).prototype=Object.create(o.prototype),n.prototype.constructor=n,a(n,o),e.prototype.lock=function(r,e,n){var o=(new t.P2PKH).lock(r);return m(o,e,n)},e}(t.P2PKH),m=function(r,e,n,o){void 0===o&&(o=!1);var i="";if(void 0!==(null==e?void 0:e.dataB64)&&void 0!==(null==e?void 0:e.contentType)){var s=l("ord"),a=Buffer.from(e.dataB64,"base64").toString("hex").trim();if(!a)throw new Error("Invalid file data");var u=l(e.contentType);if(!u)throw new Error("Invalid media type");i="OP_0 OP_IF "+s+" OP_1 "+u+" OP_0 "+a+" OP_ENDIF"}var c=(i?i+" "+(o?"OP_CODESEPARATOR ":""):"")+r.toASM();if(n&&(!n.app||!n.type))throw new Error("MAP.app and MAP.type are required fields");if(null!=n&&n.app&&null!=n&&n.type){c=(c?c+" ":"")+"OP_RETURN "+l(h)+" "+l("SET");for(var f=0,d=Object.entries(n);f<d.length;f++){var p=d[f],v=p[0],y=p[1];"cmd"!==v&&(c=c+" "+l(v)+" "+l(y))}}return t.LockingScript.fromASM(c)};exports.TokenSelectionStrategy=void 0,(u=exports.TokenSelectionStrategy||(exports.TokenSelectionStrategy={})).SmallestFirst="smallest",u.LargestFirst="largest",u.RetainOrder="retain",u.Random="random",exports.TokenType=void 0,(c=exports.TokenType||(exports.TokenType={})).BSV20="bsv20",c.BSV21="bsv21",exports.RoytaltyType=void 0,(f=exports.RoytaltyType||(exports.RoytaltyType={})).Paymail="paymail",f.Address="address",f.Script="script",exports.TokenInputMode=void 0,(d=exports.TokenInputMode||(exports.TokenInputMode={})).All="all",d.Needed="needed";var g=Math.pow(2n,64n)-1n,w=t.Utils.fromBase58Check,b=function(r,e){return t.fromUtxo(s({},r,{script:Buffer.from(r.script,"base64").toString("hex")}),e)},k=function(t,r){try{var n,o=function(t){if(n)return t;throw new Error("Signer must be a LocalSigner or RemoteSigner")},i=null==r?void 0:r.idKey,s=null==r?void 0:r.keyHost;if(i){var a=new e.Sigma(t).sign(i);return Promise.resolve(a.signedTx)}var u=function(){if(s){var o=null==r?void 0:r.authToken,i=new e.Sigma(t);return function(t,r){try{var e=Promise.resolve(i.remoteSign(s,o)).then(function(t){return n=1,t.signedTx})}catch(t){return r(t)}return e&&e.then?e.then(void 0,r):e}(0,function(t){throw console.log(t),new Error("Remote signing to "+s+" failed")})}}();return Promise.resolve(u&&u.then?u.then(o):o(u))}catch(t){return Promise.reject(t)}},P=function(t){if(t){for(var r={app:t.app,type:t.type},e=0,n=Object.entries(t);e<n.length;e++){var o=n[e],i=o[1];void 0!==i&&(r[o[0]]="string"==typeof i?i:Array.isArray(i)||"object"==typeof i?JSON.stringify(i):String(i))}return r}};const S="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function x(t,r,e){if(!t.s){if(e instanceof I){if(!e.s)return void(e.o=x.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then(x.bind(null,t,r),x.bind(null,t,2));t.s=r,t.v=e;var n=t.o;n&&n(t)}}var I=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{x(n,1,i(this.v))}catch(t){x(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?x(n,1,r?r(o):o):e?x(n,1,e(o)):x(n,2,o)}catch(t){x(n,2,t)}},n},t}();function B(t){return t instanceof I&&1&t.s}const T="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function O(t,r,e){if(!t.s){if(e instanceof E){if(!e.s)return void(e.o=O.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then(O.bind(null,t,r),O.bind(null,t,2));t.s=r,t.v=e;var n=t.o;n&&n(t)}}var E=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{O(n,1,i(this.v))}catch(t){O(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?O(n,1,r?r(o):o):e?O(n,1,e(o)):O(n,2,o)}catch(t){O(n,2,t)}},n},t}();function A(t){return t instanceof E&&1&t.s}const N="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function K(t,r,e){if(!t.s){if(e instanceof U){if(!e.s)return void(e.o=K.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then(K.bind(null,t,r),K.bind(null,t,2));t.s=r,t.v=e;var n=t.o;n&&n(t)}}var U=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{K(n,1,i(this.v))}catch(t){K(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?K(n,1,r?r(o):o):e?K(n,1,e(o)):K(n,2,o)}catch(t){K(n,2,t)}},n},t}();function j(t){return t instanceof U&&1&t.s}const q="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function H(t,r,e){if(!t.s){if(e instanceof _){if(!e.s)return void(e.o=H.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then(H.bind(null,t,r),H.bind(null,t,2));t.s=r,t.v=e;var n=t.o;n&&n(t)}}var _=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{H(n,1,i(this.v))}catch(t){H(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?H(n,1,r?r(o):o):e?H(n,1,e(o)):H(n,2,o)}catch(t){H(n,2,t)}},n},t}();function C(t){return t instanceof _&&1&t.s}var L=/*#__PURE__*/function(){function r(){}var e=r.prototype;return e.lock=function(e,n,o,i){var s=t.Utils.fromBase58Check(e).data,a=t.Utils.fromBase58Check(n).data,u=new t.Script;if(void 0!==(null==i?void 0:i.dataB64)&&void 0!==(null==i?void 0:i.contentType)){var c=l("ord"),f=Buffer.from(i.dataB64,"base64").toString("hex").trim();if(!f)throw new Error("Invalid file data");var d=l(i.contentType);if(!d)throw new Error("Invalid media type");u=t.Script.fromASM("OP_0 OP_IF "+c+" OP_1 "+d+" OP_0 "+f+" OP_ENDIF")}return u.writeScript(t.Script.fromHex("2097dfd76851bf465e8f715593b217714858bbe9570ff3bd5e33840a34e20ff0262102ba79df5f8ae7604a9830f03c7933028186aede0675a16f025dc4f8be8eec0382201008ce7480da41702918d1ec8e6849ba32b4d65b1e40dc669c31a1e6306b266c0000")).writeBin(s).writeBin(r.buildOutput(o,(new t.P2PKH).lock(a).toBinary())).writeScript(t.Script.fromHex("615179547a75537a537a537a0079537a75527a527a7575615579008763567901c161517957795779210ac407f0e4bd44bfc207355a778b046225a7068fc59ee7eda43ad905aadbffc800206c266b30e6a1319c66dc401e5bd6b432ba49688eecd118297041da8074ce081059795679615679aa0079610079517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01007e81517a75615779567956795679567961537956795479577995939521414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff00517951796151795179970079009f63007952799367007968517a75517a75517a7561527a75517a517951795296a0630079527994527a75517a6853798277527982775379012080517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01205279947f7754537993527993013051797e527e54797e58797e527e53797e52797e57797e0079517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a756100795779ac517a75517a75517a75517a75517a75517a75517a75517a75517a7561517a75517a756169587951797e58797eaa577961007982775179517958947f7551790128947f77517a75517a75618777777777777777777767557951876351795779a9876957795779ac777777777777777767006868"))},e.cancelListing=function(r,e,n,o,i){void 0===e&&(e="all"),void 0===n&&(n=!1);var s=(new t.P2PKH).unlock(r,e,n,o,i);return{sign:function(r,e){try{return Promise.resolve(s.sign(r,e)).then(function(r){return r.writeOpCode(t.OP.OP_1)})}catch(t){return Promise.reject(t)}},estimateLength:function(){return Promise.resolve(107)}}},e.purchaseListing=function(e,n){var o={sign:function(o,s){try{var a;if(o.outputs.length<2)throw new Error("Malformed transaction");var u=(new t.UnlockingScript).writeBin(r.buildOutput(o.outputs[0].satoshis||0,o.outputs[0].lockingScript.toBinary()));if(o.outputs.length>2){for(var c,f=new t.Utils.Writer,d=i(o.outputs.slice(2));!(c=d()).done;){var l=c.value;f.write(r.buildOutput(l.satoshis||0,l.lockingScript.toBinary()))}u.writeBin(f.toArray())}else u.writeOpCode(t.OP.OP_0);var h=o.inputs[s],p=e;if(!p&&h.sourceTransaction)p=h.sourceTransaction.outputs[h.sourceOutputIndex].satoshis;else if(!e)throw new Error("sourceTransaction or sourceSatoshis is required");var v,y=h.sourceTXID||(null==(a=h.sourceTransaction)?void 0:a.id("hex")),m=n;m||(m=null==(v=h.sourceTransaction)?void 0:v.outputs[h.sourceOutputIndex].lockingScript);var g=t.TransactionSignature.format({sourceTXID:y,sourceOutputIndex:h.sourceOutputIndex,sourceSatoshis:p,transactionVersion:o.version,otherInputs:[],inputIndex:s,outputs:o.outputs,inputSequence:h.sequence,subscript:m,lockTime:o.lockTime,scope:t.TransactionSignature.SIGHASH_ALL|t.TransactionSignature.SIGHASH_ANYONECANPAY|t.TransactionSignature.SIGHASH_FORKID});return Promise.resolve(u.writeBin(g).writeOpCode(t.OP.OP_0))}catch(t){return Promise.reject(t)}},estimateLength:function(t,r){try{return Promise.resolve(o.sign(t,r)).then(function(t){return t.toBinary().length})}catch(t){return Promise.reject(t)}}};return o},r.buildOutput=function(r,e){var n=new t.Utils.Writer;return n.writeUInt64LEBn(new t.BigNumber(r)),n.writeVarIntNum(e.length),n.write(e),n.toArray()},r}(),R="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function D(t,r,e){if(!t.s){if(e instanceof F){if(!e.s)return void(e.o=D.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then(D.bind(null,t,r),D.bind(null,t,2));t.s=r,t.v=e;var n=t.o;n&&n(t)}}var F=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{D(n,1,i(this.v))}catch(t){D(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?D(n,1,r?r(o):o):e?D(n,1,e(o)):D(n,2,o)}catch(t){D(n,2,t)}},n},t}();function M(t){return t instanceof F&&1&t.s}var V=t.Utils.toArray;function J(t,r,e){if("function"==typeof t[R]){var n,o,i,s=t[R]();if(function t(a){try{for(;!((n=s.next()).done||e&&e());)if((a=r(n.value))&&a.then){if(!M(a))return void a.then(t,i||(i=D.bind(null,o=new F,2)));a=a.v}o?D(o,1,a):o=a}catch(t){D(o||(o=new F),2,t)}}(),s.return){var a=function(t){try{n.done||s.return()}catch(t){}return t};if(o&&o.then)return o.then(a,function(t){throw a(t)});a()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<t.length;c++)u.push(t[c]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!M(a))return void a.then(s,o||(o=D.bind(null,n=new F,2)));a=a.v}n?D(n,1,a):n=a}catch(t){D(n||(n=new F),2,t)}}(),n}(u,function(t){return r(u[t])},e)}const X="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function W(t,r,e){if(!t.s){if(e instanceof G){if(!e.s)return void(e.o=W.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then(W.bind(null,t,r),W.bind(null,t,2));t.s=r,t.v=e;var n=t.o;n&&n(t)}}var G=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{W(n,1,i(this.v))}catch(t){W(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?W(n,1,r?r(o):o):e?W(n,1,e(o)):W(n,2,o)}catch(t){W(n,2,t)}},n},t}();function Y(t){return t instanceof G&&1&t.s}function Q(t,r,e){if("function"==typeof t[X]){var n,o,i,s=function(t){try{for(;!((n=a.next()).done||e&&e());)if((t=r(n.value))&&t.then){if(!Y(t))return void t.then(s,i||(i=W.bind(null,o=new G,2)));t=t.v}o?W(o,1,t):o=t}catch(t){W(o||(o=new G),2,t)}},a=t[X]();if(s(),a.return){var u=function(t){try{n.done||a.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],f=0;f<t.length;f++)c.push(t[f]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!Y(a))return void a.then(s,o||(o=W.bind(null,n=new G,2)));a=a.v}n?W(n,1,a):n=a}catch(t){W(n||(n=new G),2,t)}}(),n}(c,function(t){return r(c[t])},e)}function $(t,r,e){if(!t.s){if(e instanceof z){if(!e.s)return void(e.o=$.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then($.bind(null,t,r),$.bind(null,t,2));t.s=r,t.v=e;const n=t.o;n&&n(t)}}var z=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{$(n,1,i(this.v))}catch(t){$(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?$(n,1,r?r(o):o):e?$(n,1,e(o)):$(n,2,o)}catch(t){$(n,2,t)}},n},t}(),Z="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function tt(t){return t instanceof z&&1&t.s}function rt(t,r,e){if("function"==typeof t[Z]){var n,o,i,s=function(t){try{for(;!((n=a.next()).done||e&&e());)if((t=r(n.value))&&t.then){if(!tt(t))return void t.then(s,i||(i=$.bind(null,o=new z,2)));t=t.v}o?$(o,1,t):o=t}catch(t){$(o||(o=new z),2,t)}},a=t[Z]();if(s(),a.return){var u=function(t){try{n.done||a.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],f=0;f<t.length;f++)c.push(t[f]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!tt(a))return void a.then(s,o||(o=$.bind(null,n=new z,2)));a=a.v}n?$(n,1,a):n=a}catch(t){$(n||(n=new z),2,t)}}(),n}(c,function(t){return r(c[t])},e)}var et=t.Utils.toArray,nt=new Error("Image must be a square image with dimensions <= 400x400"),ot=new Error("Image must be a square image"),it=new Error("Error processing image"),st=new Error("Image dimensions are undefined");const at="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function ut(t,r,e){if(!t.s){if(e instanceof ct){if(!e.s)return void(e.o=ut.bind(null,t,r));1&r&&(r=e.s),e=e.v}if(e&&e.then)return void e.then(ut.bind(null,t,r),ut.bind(null,t,2));t.s=r,t.v=e;var n=t.o;n&&n(t)}}var ct=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(r,e){var n=new t,o=this.s;if(o){var i=1&o?r:e;if(i){try{ut(n,1,i(this.v))}catch(t){ut(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?ut(n,1,r?r(o):o):e?ut(n,1,e(o)):ut(n,2,o)}catch(t){ut(n,2,t)}},n},t}();function ft(t){return t instanceof ct&&1&t.s}var dt=/*#__PURE__*/function(){function t(t){this.fetch=void 0,this.fetch=t}return t.prototype.request=function(t,r){try{var e={method:r.method,headers:r.headers,body:JSON.stringify(r.data)};return Promise.resolve(this.fetch.call(window,t,e)).then(function(t){var r=t.headers.get("Content-Type");return Promise.resolve(null!=r&&r.startsWith("application/json")?t.json():t.text()).then(function(r){return{ok:t.ok,status:t.status,statusText:t.statusText,data:r}})})}catch(t){return Promise.reject(t)}},t}(),lt=/*#__PURE__*/function(){function r(r){void 0===r&&(r=function(){var r={request:function(){try{throw new Error("No method available to perform HTTP request")}catch(t){return Promise.reject(t)}}};if("undefined"!=typeof window&&"function"==typeof window.fetch){var e=window.fetch;return window.fetch=function(){try{return Promise.resolve(e.apply(void 0,[].slice.call(arguments)))}catch(t){return Promise.reject(t)}},new dt(window.fetch)}if("undefined"==typeof require)return r;try{var n=require("node:https");return new t.NodejsHttpClient(n)}catch(t){return r}}()),this.URL=void 0,this.httpClient=void 0,this.URL=v+"/tx",this.httpClient=r}return r.prototype.broadcast=function(r){try{var e=this,n={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:{rawtx:t.Utils.toBase64(r.toBinary())}};return Promise.resolve(function(t,r){try{var o=Promise.resolve(e.httpClient.request(e.URL,n)).then(function(t){var r,e;return t.ok?{status:"success",txid:t.data,message:"broadcast successful"}:{status:"error",code:null!=(r=t.status.toString())?r:"ERR_UNKNOWN",description:null!=(e=t.data.message)?e:"Unknown error"}})}catch(t){return r(t)}return o&&o.then?o.then(void 0,r):o}(0,function(t){return{status:"error",code:"500",description:t instanceof Error?t.message:"Internal Server Error"}}))}catch(t){return Promise.reject(t)}},r}();exports.MAX_TOKEN_SUPPLY=g,exports.OneSatBroadcaster=lt,exports.OrdLock=L,exports.OrdP2PKH=y,exports.applyInscription=m,exports.burnOrdinals=function(r){try{for(var e,n=new t.Transaction,o=[],s=r.metaData,a=r.ordPk,u=i(r.ordinals);!(e=u()).done;){var c=e.value;if(1!==c.satoshis)throw new Error("1Sat Ordinal utxos must have exactly 1 satoshi");var f=c.pk||a;if(!f)throw new Error("Private key is required to sign the ordinal");var d=b(c,(new y).unlock(f,"all",!0,c.satoshis,t.Script.fromBinary(t.Utils.toArray(c.script,"base64"))));o.push(c.txid+"_"+c.vout),n.addInput(d)}if(s&&(!s.app||!s.type))throw new Error("MAP.app and MAP.type are required fields");var p="";if(null!=s&&s.app&&null!=s&&s.type){p="OP_FALSE OP_RETURN "+l(h)+" "+l("SET");for(var v=0,m=Object.entries(s);v<m.length;v++){var g=m[v],w=g[0],k=g[1];"cmd"!==w&&(p=p+" "+l(w)+" "+l(k))}}return n.addOutput({satoshis:0,lockingScript:t.Script.fromASM(p||"OP_FALSE OP_RETURN")}),Promise.resolve(n.sign()).then(function(){return{tx:n,spentOutpoints:o}})}catch(t){return Promise.reject(t)}},exports.cancelOrdListings=function(r){try{var e,n=function(t){if(O<E+BigInt(A))throw new Error("Not enough funds to cancel ordinal listings. Total sats in: "+O+", Total sats out: "+E+", Fee: "+A);return Promise.resolve(m.fee(y)).then(function(){return Promise.resolve(m.sign()).then(function(){var t=m.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=m.outputs[t];v={satoshis:r.satoshis,txid:m.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return v&&(v.satoshis=m.outputs[m.outputs.length-1].satoshis,v.txid=m.id("hex")),{tx:m,spentOutpoints:m.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:v}})})},o=r.utxos,s=r.listingUtxos,a=r.ordPk,u=r.paymentPk,c=r.additionalPayments,f=void 0===c?[]:c,d=r.satsPerKb,l=void 0===d?p:d;s.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var h,v,y=new t.SatoshisPerKilobyte(l),m=new t.Transaction,g=i(s);!(h=g()).done;){var w=h.value,k=w.pk||a;if(!k)throw new Error("Private key required for token input");m.addInput(b(w,(new L).cancelListing(k,"all",!0,w.satoshis,t.Script.fromBinary(t.Utils.toArray(w.script,"base64"))))),m.addOutput({satoshis:1,lockingScript:(new t.P2PKH).lock(k.toAddress().toString())})}for(var P,S=i(f);!(P=S()).done;){var x=P.value;m.addOutput({satoshis:x.amount,lockingScript:(new t.P2PKH).lock(x.to)})}var I=r.changeAddress||(null==u?void 0:u.toAddress());if(!I)throw new Error("paymentPk or changeAddress required for payment change");var B=I,T=(new t.P2PKH).lock(B);m.addOutput({lockingScript:T,change:!0});var O=0n,E=m.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),A=0,N=Q(o,function(r){var n=r.pk||u;if(!n)throw new Error("paymentPk required for payment utxo");var o=b(r,(new t.P2PKH).unlock(n,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return m.addInput(o),O+=BigInt(r.satoshis),Promise.resolve(y.computeFee(m)).then(function(t){A=t,O>=E+BigInt(A)&&(e=1)})},function(){return e||void 0});return Promise.resolve(N&&N.then?N.then(n):n())}catch(t){return Promise.reject(t)}},exports.cancelOrdTokenListings=function(r){try{var e,n=function(t){if(H<_+BigInt(C))throw new Error("Not enough funds to cancel token listings. Total sats in: "+H+", Total sats out: "+_+", Fee: "+C);return Promise.resolve(k.fee(w)).then(function(){return Promise.resolve(k.sign()).then(function(){var t=[{amt:m.toString(),script:Buffer.from(A.toHex(),"hex").toString("base64"),txid:k.id("hex"),vout:0,id:a,satoshis:1}],r=k.outputs.findIndex(function(t){return t.change});if(-1!==r){var e=k.outputs[r];O={satoshis:e.satoshis,txid:k.id("hex"),vout:r,script:Buffer.from(e.lockingScript.toBinary()).toString("base64")}}return O&&(O.satoshis=k.outputs[k.outputs.length-1].satoshis,O.txid=k.id("hex")),{tx:k,spentOutpoints:k.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:O,tokenChange:t}})})},o=r.protocol,a=r.tokenID,u=r.paymentPk,c=r.ordPk,f=r.additionalPayments,d=r.listingUtxos,l=r.utxos,h=r.satsPerKb,v=void 0===h?p:h,m=0;if(d.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead."),!d.every(function(t){return t.id===a}))throw new Error("Input tokens do not match the provided tokenID");for(var g,w=new t.SatoshisPerKilobyte(v),k=new t.Transaction,P=i(d);!(g=P()).done;){var S=g.value,x=S.pk||c;if(!x)throw new Error("Private key required for token input");k.addInput(b(S,(new L).cancelListing(x,"all",!0,S.satoshis,t.Script.fromBinary(t.Utils.toArray(S.script,"base64"))))),m+=Number.parseInt(S.amt)}var I,B={p:"bsv-20",op:"transfer",amt:m.toString()};if(o===exports.TokenType.BSV20)I=s({},B,{tick:a});else{if(o!==exports.TokenType.BSV21)throw new Error("Invalid protocol");I=s({},B,{id:a})}var T=r.ordAddress||(null==c?void 0:c.toAddress());if(!T)throw new Error("ordAddress or ordPk required for token output");var O,E={address:T,inscription:{dataB64:Buffer.from(JSON.stringify(I)).toString("base64"),contentType:"application/bsv-20"}},A=(new y).lock(E.address,E.inscription);k.addOutput({satoshis:1,lockingScript:A});for(var N,K=i(f);!(N=K()).done;){var U=N.value;k.addOutput({satoshis:U.amount,lockingScript:(new t.P2PKH).lock(U.to)})}var j=r.changeAddress||(null==u?void 0:u.toAddress());if(!j)throw new Error("paymentPk or changeAddress required for payment change");var q=(new t.P2PKH).lock(j);k.addOutput({lockingScript:q,change:!0});var H=0n,_=k.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),C=0,R=Q(l,function(r){var n=r.pk||u;if(!n)throw new Error("paymentPk required for payment utxo");var o=b(r,(new t.P2PKH).unlock(n,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return k.addInput(o),H+=BigInt(r.satoshis),Promise.resolve(w.computeFee(k)).then(function(t){C=t,H>=_+BigInt(C)&&(e=1)})},function(){return e||void 0});return Promise.resolve(R&&R.then?R.then(n):n())}catch(t){return Promise.reject(t)}},exports.createOrdListings=function(r){try{var e,n,o=function(t){if(E<A+BigInt(N))throw new Error("Not enough funds to create ordinal listings. Total sats in: "+E+", Total sats out: "+A+", Fee: "+N);return Promise.resolve(v.fee(h)).then(function(){return Promise.resolve(v.sign()).then(function(){var t=v.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=v.outputs[t];n={satoshis:r.satoshis,txid:v.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return n&&(n.satoshis=v.outputs[v.outputs.length-1].satoshis,n.txid=v.id("hex")),{tx:v,spentOutpoints:v.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:n}})})},s=r.utxos,a=r.listings,u=r.paymentPk,c=r.ordPk,f=r.satsPerKb,d=r.additionalPayments,l=void 0===d?[]:d,h=new t.SatoshisPerKilobyte(void 0===f?p:f),v=new t.Transaction;a.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var m,g=i(a);!(m=g()).done;){var w=m.value;v.addOutput({satoshis:1,lockingScript:(new L).lock(w.ordAddress,w.payAddress,w.price)});var k=V(w.listingUtxo.script,"base64"),P=t.Script.fromBinary(k),S=w.listingUtxo.pk||c;if(!S)throw new Error("Private key is required to sign the ordinal");v.addInput(b(w.listingUtxo,(new y).unlock(S,"all",!0,w.listingUtxo.satoshis,P)))}for(var x,I=i(l);!(x=I()).done;){var B=x.value;v.addOutput({satoshis:B.amount,lockingScript:(new t.P2PKH).lock(B.to)})}var T=r.changeAddress||(null==u?void 0:u.toAddress());if(!T)throw new Error("changeAddress or private key is required");var O=(new t.P2PKH).lock(T);v.addOutput({lockingScript:O,change:!0});var E=0n,A=v.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),N=0,K=J(s,function(r){var n=r.pk||u;if(!n)throw new Error("Private key is required to sign the transaction");var o=b(r,(new t.P2PKH).unlock(n,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return v.addInput(o),E+=BigInt(r.satoshis),Promise.resolve(h.computeFee(v)).then(function(t){N=t,E>=A+BigInt(N)&&(e=1)})},function(){return e||void 0});return Promise.resolve(K&&K.then?K.then(o):o())}catch(t){return Promise.reject(t)}},exports.createOrdTokenListings=function(e){try{var n,o=function(t){if(z<Z+BigInt(tt))throw new Error("Not enough funds to create token listings. Total sats in: "+z+", Total sats out: "+Z+", Fee: "+tt);return Promise.resolve(A.fee(E)).then(function(){return Promise.resolve(A.sign()).then(function(){var t=A.id("hex");T&&(T=T.map(function(r){return s({},r,{txid:t})}));var r=A.outputs.findIndex(function(t){return t.change});if(-1!==r){var e=A.outputs[r];O={satoshis:e.satoshis,txid:t,vout:r,script:Buffer.from(e.lockingScript.toBinary()).toString("base64")}}return O&&(O.satoshis=A.outputs[A.outputs.length-1].satoshis,O.txid=A.id("hex")),{tx:A,spentOutpoints:A.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:O,tokenChange:T}})})},a=e.utxos,u=e.protocol,c=e.tokenID,f=e.ordPk,d=e.paymentPk,l=e.additionalPayments,h=void 0===l?[]:l,v=e.tokenChangeAddress,m=e.inputTokens,g=e.listings,w=e.decimals,k=e.satsPerKb,P=void 0===k?p:k;if(g.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead."),!m.every(function(t){return t.id===c}))throw new Error("Input tokens do not match the provided tokenID");var S=0n,x=0n,I=0n;if(!m.every(function(t){return t.id===c}))throw new Error("Input tokens do not match the provided tokenID");for(var B,T,O,E=new t.SatoshisPerKilobyte(P),A=new t.Transaction,N=i(g);!(B=N()).done;){var K=B.value,U=r.toTokenSat(K.tokens,w,r.ReturnTypes.BigInt),j={p:"bsv-20",op:"transfer",amt:U.toString()},q=void 0;if(u===exports.TokenType.BSV20)q=s({},j,{tick:c});else{if(u!==exports.TokenType.BSV21)throw new Error("Invalid protocol");q=s({},j,{id:c})}A.addOutput({satoshis:1,lockingScript:(new L).lock(K.ordAddress,K.payAddress,K.price,{dataB64:Buffer.from(JSON.stringify(q)).toString("base64"),contentType:"application/bsv-20"})}),I+=U}for(var H,_=i(m);!(H=_()).done;){var C=H.value,R=C.pk||f;if(!R)throw new Error("Private key is required to sign the ordinal");A.addInput(b(C,(new y).unlock(R,"all",!0,C.satoshis,t.Script.fromBinary(V(C.script,"base64"))))),x+=BigInt(C.amt)}if((S=x-I)<0n)throw new Error("Not enough tokens to send");if(S>0n){var D,F={p:"bsv-20",op:"transfer",amt:S.toString()};if(u===exports.TokenType.BSV20)D=s({},F,{tick:c});else{if(u!==exports.TokenType.BSV21)throw new Error("Invalid protocol");D=s({},F,{id:c})}var M=(new y).lock(v,{dataB64:Buffer.from(JSON.stringify(D)).toString("base64"),contentType:"application/bsv-20"}),X=A.outputs.length;A.addOutput({lockingScript:M,satoshis:1}),T=[{id:c,satoshis:1,script:Buffer.from(M.toBinary()).toString("base64"),txid:"",vout:X,amt:S.toString()}]}for(var W,G=i(h);!(W=G()).done;){var Y=W.value;A.addOutput({satoshis:Y.amount,lockingScript:(new t.P2PKH).lock(Y.to)})}var Q=e.changeAddress||(null==d?void 0:d.toAddress());if(!Q)throw new Error("Either changeAddress or paymentPk is required");var $=(new t.P2PKH).lock(Q);A.addOutput({lockingScript:$,change:!0});var z=0n,Z=A.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),tt=0,rt=J(a,function(r){var e=r.pk||d;if(!e)throw new Error("Private key is required to sign the payment");var o=b(r,(new t.P2PKH).unlock(e,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return A.addInput(o),z+=BigInt(r.satoshis),Promise.resolve(E.computeFee(A)).then(function(t){tt=t,z>=Z+BigInt(tt)&&(n=1)})},function(){return n||void 0});return Promise.resolve(rt&&rt.then?rt.then(o):o())}catch(t){return Promise.reject(t)}},exports.createOrdinals=function(r){try{var e=function(r){var e;function o(t){if(H<_+BigInt(i))throw new Error("Not enough funds to create ordinals. Total sats in: "+H+", Total sats out: "+_+", Fee: "+i);return Promise.resolve(g.fee(m)).then(function(){return Promise.resolve(g.sign()).then(function(){var t=g.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=g.outputs[t];v={satoshis:r.satoshis,txid:g.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return v&&(v.satoshis=g.outputs[g.outputs.length-1].satoshis,v.txid=g.id("hex")),{tx:g,spentOutpoints:n.map(function(t){return t.txid+"_"+t.vout}),payChange:v}})})}var i=0,a=function(t,r,e){if("function"==typeof t[S]){var n,o,i,s=function(t){try{for(;!((n=a.next()).done||e&&e());)if((t=r(n.value))&&t.then){if(!B(t))return void t.then(s,i||(i=x.bind(null,o=new I,2)));t=t.v}o?x(o,1,t):o=t}catch(t){x(o||(o=new I),2,t)}},a=t[S]();if(s(),a.return){var u=function(t){try{n.done||a.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],f=0;f<t.length;f++)c.push(t[f]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!B(a))return void a.then(s,o||(o=x.bind(null,n=new I,2)));a=a.v}n?x(n,1,a):n=a}catch(t){x(n||(n=new I),2,t)}}(),n}(c,function(t){return r(c[t])},e)}(n,function(r){var n=r.pk||s;if(!n)throw new Error("Private key is required to sign the transaction");if(!(H>=_+BigInt(i))){var o=b(r,(new t.P2PKH).unlock(n,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return g.addInput(o),H+=BigInt(r.satoshis),Promise.resolve(m.computeFee(g)).then(function(t){i=t})}e=1},function(){return e||void 0});return a&&a.then?a.then(o):o()},n=r.utxos,o=r.destinations,s=r.paymentPk,a=r.satsPerKb,u=void 0===a?p:a,c=r.metaData,f=r.signer,d=r.additionalPayments,l=void 0===d?[]:d;o.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var h,v,m=new t.SatoshisPerKilobyte(u),g=new t.Transaction,w=i(o);!(h=w()).done;){var T=h.value;if(!T.inscription)throw new Error("Inscription is required for all destinations");if(c)for(var O=0,E=Object.keys(c);O<E.length;O++){var A=E[O];void 0===c[A]&&delete c[A]}g.addOutput({satoshis:1,lockingScript:(new y).lock(T.address,T.inscription,P(c))})}for(var N,K=i(l);!(N=K()).done;){var U=N.value;g.addOutput({satoshis:U.amount,lockingScript:(new t.P2PKH).lock(U.to)})}var j=r.changeAddress||(null==s?void 0:s.toAddress());if(!j)throw new Error("Either changeAddress or paymentPk is required");var q=(new t.P2PKH).lock(j);g.addOutput({lockingScript:q,change:!0});var H=0n,_=g.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),C=function(){if(f){var r=n.pop(),e=r.pk||s;if(!e)throw new Error("Private key is required to sign the transaction");return g.addInput(b(r,(new t.P2PKH).unlock(e,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))))),H+=BigInt(r.satoshis),Promise.resolve(k(g,f)).then(function(t){g=t})}}();return Promise.resolve(C&&C.then?C.then(e):e())}catch(t){return Promise.reject(t)}},exports.deployBsv21Token=function(r){try{var e,o=function(n){var o;function a(e){if(B<T+BigInt(O))throw new Error("Not enough funds to deploy token. Total sats in: "+B+", Total sats out: "+T+", Fee: "+O);var n,o=r.changeAddress||(null==d?void 0:d.toAddress());if(!o)throw new Error("Either changeAddress or paymentPk is required");var i=(new t.P2PKH).lock(o);return w.addOutput({lockingScript:i,change:!0}),Promise.resolve(w.fee(g)).then(function(){return Promise.resolve(w.sign()).then(function(){var t=w.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=w.outputs[t];n={satoshis:r.satoshis,txid:w.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return{tx:w,spentOutpoints:w.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:n}})})}if(!function(t){if(!t.includes("_")||t.endsWith("_"))return!1;var r=Number.parseInt(t.split("_")[1]);return!(Number.isNaN(r)||!t.startsWith("_")&&64!==t.split("_")[0].length)}(e))throw new Error("Invalid icon format. Must be either outpoint (format: txid_vout) or relative output index of the icon (format _vout). examples: ecb483eda58f26da1b1f8f15b782b1186abdf9c6399a1c3e63e0d429d5092a41_0 or _1");var h=u?BigInt(f.tokens)*Math.pow(10n,BigInt(u)):BigInt(f.tokens),p={p:"bsv-20",op:"deploy+mint",sym:s,icon:e,amt:h.toString()};u&&(p.dec=u.toString());var v=Buffer.from(JSON.stringify(p)).toString("base64"),k={satoshis:1,lockingScript:(new y).lock(l,{dataB64:v,contentType:"application/bsv-20"})};w.addOutput(k);for(var P,S=i(m);!(P=S()).done;){var x=P.value,I={satoshis:x.amount,lockingScript:(new t.P2PKH).lock(x.to)};w.addOutput(I)}var B=0n,T=w.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),O=0,E=function(t,r,e){if("function"==typeof t[at]){var n,o,i,s=function(t){try{for(;!((n=a.next()).done||e&&e());)if((t=r(n.value))&&t.then){if(!ft(t))return void t.then(s,i||(i=ut.bind(null,o=new ct,2)));t=t.v}o?ut(o,1,t):o=t}catch(t){ut(o||(o=new ct),2,t)}},a=t[at]();if(s(),a.return){var u=function(t){try{n.done||a.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],f=0;f<t.length;f++)c.push(t[f]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!ft(a))return void a.then(s,o||(o=ut.bind(null,n=new ct,2)));a=a.v}n?ut(n,1,a):n=a}catch(t){ut(n||(n=new ct),2,t)}}(),n}(c,function(t){return r(c[t])},e)}(c,function(r){var e=r.pk||d;if(!e)throw new Error("Private key is required to sign the payment");var n=b(r,(new t.P2PKH).unlock(e,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return w.addInput(n),B+=BigInt(r.satoshis),Promise.resolve(g.computeFee(w)).then(function(t){O=t,B>=T+BigInt(O)&&(o=1)})},function(){return o||void 0});return E&&E.then?E.then(a):a()},s=r.symbol,a=r.icon,u=r.decimals,c=r.utxos,f=r.initialDistribution,d=r.paymentPk,l=r.destinationAddress,h=r.satsPerKb,v=r.additionalPayments,m=void 0===v?[]:v,g=new t.SatoshisPerKilobyte(void 0===h?p:h),w=new t.Transaction,k=function(){if("string"!=typeof a)return Promise.resolve(function(t){try{var r=t.dataB64,e=t.contentType;if("image/svg+xml"===e)return Promise.resolve(function(t){var r=Buffer.from(t,"base64").toString("utf-8"),e=r.match(/<svg[^>]*\s+width="([^"]+)"/),n=r.match(/<svg[^>]*\s+height="([^"]+)"/);if(!e||!n)return st;var o=Number.parseInt(e[1],10),i=Number.parseInt(n[1],10);return Number.isNaN(o)||Number.isNaN(i)?st:o!==i?ot:o>400||i>400?nt:null}(r));if((s=e)!=s)return Promise.resolve(it);try{var o=Uint8Array.from(et(r,"base64")),i=n.imageMeta(o);return Promise.resolve(void 0===i.width||void 0===i.height?st:i.width!==i.height?ot:i.width>400||i.height>400?nt:null)}catch(t){return Promise.resolve(it)}}catch(t){return Promise.reject(t)}var s}(a)).then(function(t){if(t)throw t;var r=(new y).lock(l,a);w.addOutput({satoshis:1,lockingScript:r}),e="_0"});e=a}();return Promise.resolve(k&&k.then?k.then(o):o())}catch(t){return Promise.reject(t)}},exports.fetchNftUtxos=function(r,e,n,o,i){void 0===n&&(n=10),void 0===o&&(o=0),void 0===i&&(i="base64");try{var s=v+"/txos/address/"+r+"/unspent?limit="+n+"&offset="+o+"&";return e&&(s+="q="+Buffer.from(JSON.stringify({map:{subTypeData:{collectionId:e}}})).toString("base64")),Promise.resolve(fetch(s)).then(function(n){if(!n.ok)throw new Error("Error fetching NFT utxos for "+r);return Promise.resolve(n.json()).then(function(n){var o=(n=n.filter(function(t){var r;return 1===t.satoshis&&!(null!=(r=t.data)&&r.list)})).map(function(t){return t.txid+"_"+t.vout});return Promise.resolve(fetch(v+"/txos/outpoints?script=true",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify([].concat(o))})).then(function(o){if(!o.ok)throw new Error("Error fetching NFT scripts for "+r);return Promise.resolve(o.json()).then(function(r){return n=r.map(function(r){var n=r.script;"hex"===i?n=Buffer.from(n,"base64").toString("hex"):"asm"===i&&(n=t.Script.fromHex(Buffer.from(n,"base64").toString("hex")).toASM());var o={origin:r.origin.outpoint,script:n,vout:r.vout,txid:r.txid,satoshis:1};return e&&(o.collectionId=e),o})})})})})}catch(t){return Promise.reject(t)}},exports.fetchPayUtxos=function(r,e){void 0===e&&(e="base64");try{var n=v+"/txos/address/"+r+"/unspent?bsv20=false";return console.log({payUrl:n}),Promise.resolve(fetch(n)).then(function(n){if(!n.ok)throw new Error("Error fetching pay utxos");return Promise.resolve(n.json()).then(function(n){n=n.filter(function(t){return 1!==t.satoshis&&!t.lock});var o=w(r),i=(new t.P2PKH).lock(o.data);return n.map(function(t){return{txid:t.txid,vout:t.vout,satoshis:t.satoshis,script:"hex"===e||"base64"===e?Buffer.from(i.toBinary()).toString(e):i.toASM()}})})})}catch(t){return Promise.reject(t)}},exports.fetchTokenUtxos=function(t,r,e,n,o){void 0===n&&(n=10),void 0===o&&(o=0);try{var i=v+"/bsv20/"+e+"/"+(t===exports.TokenType.BSV20?"tick":"id")+"/"+r+"?bsv20=true&listing=false&limit="+n+"&offset="+o;return Promise.resolve(fetch(i)).then(function(e){if(!e.ok)throw new Error("Error fetching "+t+" utxos");return Promise.resolve(e.json()).then(function(t){return t.map(function(t){return{amt:t.amt,script:t.script,vout:t.vout,txid:t.txid,id:r,satoshis:1}})})})}catch(t){return Promise.reject(t)}},exports.oneSatBroadcaster=function(){return new lt},exports.purchaseOrdListing=function(r){try{var e=function(e){var i,s;function a(t){if(f<d+BigInt(l))throw new Error("Not enough funds to purchase ordinal listing. Total sats in: "+f+", Total sats out: "+d+", Fee: "+l);return Promise.resolve(m.fee(v)).then(function(){return Promise.resolve(m.sign()).then(function(){var t=m.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=m.outputs[t];s={satoshis:r.satoshis,txid:m.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return s&&(s.satoshis=m.outputs[m.outputs.length-1].satoshis,s.txid=m.id("hex")),{tx:m,spentOutpoints:m.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:s}})})}var u=r.changeAddress||(null==o?void 0:o.toAddress());if(!u)throw new Error("Either changeAddress or paymentPk is required");var c=(new t.P2PKH).lock(u);m.addOutput({lockingScript:c,change:!0});var f=0n,d=m.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),l=0,h=rt(n,function(r){var e=r.pk||o;if(!e)throw new Error("Private key is required to sign the payment");var n=b(r,(new t.P2PKH).unlock(e,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return m.addInput(n),f+=BigInt(r.satoshis),Promise.resolve(v.computeFee(m)).then(function(t){l=t,f>=d+BigInt(l)&&(i=1)})},function(){return i||void 0});return h&&h.then?h.then(a):a()},n=r.utxos,o=r.paymentPk,s=r.listing,a=r.ordAddress,u=r.additionalPayments,c=void 0===u?[]:u,f=r.satsPerKb,d=r.royalties,l=void 0===d?[]:d,h=r.metaData,v=new t.SatoshisPerKilobyte(void 0===f?p:f),m=new t.Transaction;m.addInput(b(s.listingUtxo,(new L).purchaseListing(1,t.Script.fromBinary(t.Utils.toArray(s.listingUtxo.script,"base64"))))),m.addOutput({satoshis:1,lockingScript:(new y).lock(a,void 0,h)});var g=new t.Utils.Reader(t.Utils.toArray(s.payout,"base64")),w=g.readUInt64LEBn().toNumber(),k=g.readVarIntNum(),P=g.read(k),S=t.LockingScript.fromBinary(P);m.addOutput({satoshis:w,lockingScript:S});for(var x,I=i(c);!(x=I()).done;){var B=x.value;m.addOutput({satoshis:B.amount,lockingScript:(new t.P2PKH).lock(B.to)})}var T=rt(l,function(r){var e;function n(t){if(!e)throw new Error("Invalid royalty destination");m.addOutput({satoshis:o,lockingScript:e})}var o=Math.floor(Number(r.percentage)*w),i=function(t,r){var e,n=-1;t:{for(var o=0;o<r.length;o++){var i=r[o][0];if(i){var s=i();if(s&&s.then)break t;if(s===t){n=o;break}}else n=o}if(-1!==n){do{for(var a=r[n][1];!a;)n++,a=r[n][1];var u=a();if(u&&u.then){e=!0;break t}var c=r[n][2];n++}while(c&&!c());return u}}var f=new z,d=$.bind(null,f,2);return(e?u.then(l):s.then(function e(s){for(;;){if(s===t){n=o;break}if(++o===r.length){if(-1!==n)break;return void $(f,1,u)}if(i=r[o][0]){if((s=i())&&s.then)return void s.then(e).then(void 0,d)}else n=o}do{for(var a=r[n][1];!a;)n++,a=r[n][1];var u=a();if(u&&u.then)return void u.then(l).then(void 0,d);var c=r[n][2];n++}while(c&&!c());$(f,1,u)})).then(void 0,d),f;function l(t){for(;;){var e=r[n][2];if(!e||e())break;n++;for(var o=r[n][1];!o;)n++,o=r[n][1];if((t=o())&&t.then)return void t.then(l).then(void 0,d)}$(f,1,t)}}(r.type,[[function(){return exports.RoytaltyType.Paymail},function(){return Promise.resolve(function(){try{throw new Error("Not implemented")}catch(t){return Promise.reject(t)}}()).then(function(t){e=t})}],[function(){return exports.RoytaltyType.Script},function(){e=t.Script.fromBinary(t.Utils.toArray(r.destination,"base64"))}],[function(){return exports.RoytaltyType.Address},function(){e=(new t.P2PKH).lock(r.destination)}],[void 0,function(){throw new Error("Invalid royalty type")}]]);return i&&i.then?i.then(n):n()},function(){});return Promise.resolve(T&&T.then?T.then(e):e())}catch(t){return Promise.reject(t)}},exports.purchaseOrdTokenListing=function(r){try{var e,n=function(t){if(q<H+BigInt(_))throw new Error("Not enough funds to purchase token listing. Total sats in: "+q+", Total sats out: "+H+", Fee: "+_);return Promise.resolve(w.fee(g)).then(function(){return Promise.resolve(w.sign()).then(function(){var t=w.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=w.outputs[t];x={satoshis:r.satoshis,txid:w.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return x&&(x.satoshis=w.outputs[w.outputs.length-1].satoshis,x.txid=w.id("hex")),{tx:w,spentOutpoints:w.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:x}})})},o=r.protocol,a=r.tokenID,u=r.utxos,c=r.paymentPk,f=r.listingUtxo,d=r.ordAddress,l=r.satsPerKb,h=r.additionalPayments,v=void 0===h?[]:h,m=r.metaData,g=new t.SatoshisPerKilobyte(void 0===l?p:l),w=new t.Transaction;w.addInput(b(f,(new L).purchaseListing(1,t.Script.fromBinary(t.Utils.toArray(f.script,"base64")))));var k,P={p:"bsv-20",op:"transfer",amt:f.amt};if(o===exports.TokenType.BSV20)k=s({},P,{tick:a});else{if(o!==exports.TokenType.BSV21)throw new Error("Invalid protocol");k=s({},P,{id:a})}var S=Buffer.from(JSON.stringify(k)).toString("base64");if(w.addOutput({satoshis:1,lockingScript:(new y).lock(d,{dataB64:S,contentType:"application/bsv-20"},m)}),!f.payout)throw new Error("Listing UTXO does not have a payout script");var x,I=new t.Utils.Reader(t.Utils.toArray(f.payout,"base64")),B=I.readUInt64LEBn().toNumber(),T=I.readVarIntNum(),O=I.read(T),E=t.LockingScript.fromBinary(O);w.addOutput({satoshis:B,lockingScript:E});for(var A,N=i(v);!(A=N()).done;){var K=A.value;w.addOutput({satoshis:K.amount,lockingScript:(new t.P2PKH).lock(K.to)})}var U=r.changeAddress||(null==c?void 0:c.toAddress());if(!U)throw new Error("Either changeAddress or paymentPk is required");var j=(new t.P2PKH).lock(U);w.addOutput({lockingScript:j,change:!0});var q=0n,H=w.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),_=0,C=rt(u,function(r){var n=r.pk||c;if(!n)throw new Error("Private key is required to sign the payment");var o=b(r,(new t.P2PKH).unlock(n,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return w.addInput(o),q+=BigInt(r.satoshis),Promise.resolve(g.computeFee(w)).then(function(t){_=t,q>=H+BigInt(_)&&(e=1)})},function(){return e||void 0});return Promise.resolve(C&&C.then?C.then(n):n())}catch(t){return Promise.reject(t)}},exports.selectTokenUtxos=function(t,e,n,o){void 0===o&&(o={});for(var s,a=o.inputStrategy,u=void 0===a?exports.TokenSelectionStrategy.RetainOrder:a,c=o.outputStrategy,f=void 0===c?exports.TokenSelectionStrategy.RetainOrder:c,d=0,l=[],h=i([].concat(t).sort(function(t,r){if(u===exports.TokenSelectionStrategy.RetainOrder)return 0;var e=BigInt(t.amt),n=BigInt(r.amt);switch(u){case exports.TokenSelectionStrategy.SmallestFirst:return Number(e-n);case exports.TokenSelectionStrategy.LargestFirst:return Number(n-e);case exports.TokenSelectionStrategy.Random:return Math.random()-.5;default:return 0}}));!(s=h()).done;){var p=s.value;if(l.push(p),(d+=r.toToken(p.amt,n))>=e&&e>0)break}return f!==exports.TokenSelectionStrategy.RetainOrder&&l.sort(function(t,r){var e=BigInt(t.amt),n=BigInt(r.amt);switch(f){case exports.TokenSelectionStrategy.SmallestFirst:return Number(e-n);case exports.TokenSelectionStrategy.LargestFirst:return Number(n-e);case exports.TokenSelectionStrategy.Random:return Math.random()-.5;default:return 0}}),{selectedUtxos:l,totalSelected:d,isEnough:d>=e}},exports.sendOrdinals=function(r){try{var e,n=function(t){function e(){return Promise.resolve(f.fee(c)).then(function(){return Promise.resolve(f.sign()).then(function(){var t=f.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=f.outputs[t];s={satoshis:r.satoshis,txid:f.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return s&&(s.satoshis=f.outputs[f.outputs.length-1].satoshis,s.txid=f.id("hex")),{tx:f,spentOutpoints:d,payChange:s}})})}if(H<_)throw new Error("Not enough ordinals to send");var n=function(){if(r.signer)return Promise.resolve(k(f,r.signer)).then(function(t){f=t})}();return n&&n.then?n.then(e):e()};r.satsPerKb||(r.satsPerKb=p),r.additionalPayments||(r.additionalPayments=[]),void 0===r.enforceUniformSend&&(r.enforceUniformSend=!0);for(var o,s,a=r.ordPk,u=r.paymentPk,c=new t.SatoshisPerKilobyte(r.satsPerKb),f=new t.Transaction,d=[],l=i(r.ordinals);!(o=l()).done;){var h=o.value,v=h.pk||a;if(!v)throw new Error("Private key is required to sign the ordinal");if(1!==h.satoshis)throw new Error("1Sat Ordinal utxos must have exactly 1 satoshi");var m=b(h,(new y).unlock(v,"all",!0,h.satoshis,t.Script.fromBinary(t.Utils.toArray(h.script,"base64"))));d.push(h.txid+"_"+h.vout),f.addInput(m)}if(r.enforceUniformSend&&r.destinations.length!==r.ordinals.length)throw new Error("Number of destinations must match number of ordinals being sent");for(var g,w=i(r.destinations);!(g=w()).done;){var S,x,I,B=g.value;I=null!=(S=B.inscription)&&S.dataB64&&null!=(x=B.inscription)&&x.contentType?(new y).lock(B.address,B.inscription,P(r.metaData)):(new t.P2PKH).lock(B.address),f.addOutput({satoshis:1,lockingScript:I})}for(var N,K=i(r.additionalPayments);!(N=K()).done;){var U=N.value;f.addOutput({satoshis:U.amount,lockingScript:(new t.P2PKH).lock(U.to)})}var j=r.changeAddress||(null==u?void 0:u.toAddress());if(!j)throw new Error("Either changeAddress or paymentPk is required");var q=(new t.P2PKH).lock(j);f.addOutput({lockingScript:q,change:!0});var H=0n,_=f.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),C=function(t,r,e){if("function"==typeof t[T]){var n,o,i,s=function(t){try{for(;!((n=a.next()).done||e&&e());)if((t=r(n.value))&&t.then){if(!A(t))return void t.then(s,i||(i=O.bind(null,o=new E,2)));t=t.v}o?O(o,1,t):o=t}catch(t){O(o||(o=new E),2,t)}},a=t[T]();if(s(),a.return){var u=function(t){try{n.done||a.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],f=0;f<t.length;f++)c.push(t[f]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!A(a))return void a.then(s,o||(o=O.bind(null,n=new E,2)));a=a.v}n?O(n,1,a):n=a}catch(t){O(n||(n=new E),2,t)}}(),n}(c,function(t){return r(c[t])},e)}(r.paymentUtxos,function(r){var n=r.pk||u;if(!n)throw new Error("Private key is required to sign the payment");var o=b(r,(new t.P2PKH).unlock(n,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return d.push(r.txid+"_"+r.vout),f.addInput(o),H+=BigInt(r.satoshis),Promise.resolve(c.computeFee(f)).then(function(t){H>=_+BigInt(t)&&(e=1)})},function(){return e||void 0});return Promise.resolve(C&&C.then?C.then(n):n())}catch(t){return Promise.reject(t)}},exports.sendUtxos=function(r){try{for(var e,n,o=function(e){if(g<w+k)throw new Error("Not enough funds to send. Total sats in: "+g+", Total sats out: "+w+", Fee: "+k);var n;if(g>w+k){var o=r.changeAddress||(null==a?void 0:a.toAddress());if(!o)throw new Error("Either changeAddress or paymentPk is required");var i=(new t.P2PKH).lock(o),u={lockingScript:i,change:!0};n={txid:"",vout:l.outputs.length,satoshis:0,script:Buffer.from(i.toHex(),"hex").toString("base64")},l.addOutput(u)}else g<w+k&&console.log("No change needed");return Promise.resolve(l.fee(d)).then(function(){return Promise.resolve(l.sign()).then(function(){var t=l.outputs.findIndex(function(t){return t.change});if(-1!==t){var r=l.outputs[t];n={satoshis:r.satoshis,txid:l.id("hex"),vout:t,script:Buffer.from(r.lockingScript.toBinary()).toString("base64")}}return n&&(n.satoshis=l.outputs[l.outputs.length-1].satoshis,n.txid=l.id("hex")),{tx:l,spentOutpoints:s.map(function(t){return t.txid+"_"+t.vout}),payChange:n}})})},s=r.utxos,a=r.paymentPk,u=r.payments,c=r.satsPerKb,f=r.metaData,d=new t.SatoshisPerKilobyte(void 0===c?p:c),l=new t.Transaction,h=i(u);!(n=h()).done;){var v=n.value,m={satoshis:v.amount,lockingScript:(new y).lock(v.to,void 0,f)};l.addOutput(m)}var g=0n,w=l.outputs.reduce(function(t,r){return t+(r.satoshis||0)},0),k=0,P=function(t,r,e){if("function"==typeof t[N]){var n,o,i,s=function(t){try{for(;!((n=a.next()).done||e&&e());)if((t=r(n.value))&&t.then){if(!j(t))return void t.then(s,i||(i=K.bind(null,o=new U,2)));t=t.v}o?K(o,1,t):o=t}catch(t){K(o||(o=new U),2,t)}},a=t[N]();if(s(),a.return){var u=function(t){try{n.done||a.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],f=0;f<t.length;f++)c.push(t[f]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!j(a))return void a.then(s,o||(o=K.bind(null,n=new U,2)));a=a.v}n?K(n,1,a):n=a}catch(t){K(n||(n=new U),2,t)}}(),n}(c,function(t){return r(c[t])},e)}(s,function(r){var n=r.pk||a;if(!n)throw new Error("Private key is required to sign the utxos");var o=b(r,(new t.P2PKH).unlock(n,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return l.addInput(o),g+=BigInt(r.satoshis),Promise.resolve(d.computeFee(l)).then(function(t){g>=w+(k=t)&&(e=1)})},function(){return e||void 0});return Promise.resolve(P&&P.then?P.then(o):o())}catch(t){return Promise.reject(t)}},exports.stringifyMetaData=P,exports.transferOrdTokens=function(e){try{var n,o=function(t){function r(){return Promise.resolve(M.fee(F)).then(function(){return Promise.resolve(M.sign()).then(function(){for(var t,r=M.id("hex"),e=i(dt);!(t=e()).done;)t.value.txid=r;var n=M.outputs.findIndex(function(t){return t.change});if(-1!==n){var o=M.outputs[n];ft={satoshis:o.satoshis,txid:r,vout:n,script:Buffer.from(o.lockingScript.toBinary()).toString("base64")}}return ft&&(ft.satoshis=M.outputs[M.outputs.length-1].satoshis,ft.txid=M.id("hex")),{tx:M,spentOutpoints:M.inputs.map(function(t){return t.sourceTXID+"_"+t.sourceOutputIndex}),payChange:ft,tokenChange:dt}})})}if(gt<wt+BigInt(bt))throw new Error("Not enough funds to transfer tokens. Total sats in: "+gt+", Total sats out: "+wt+", Fee: "+bt);var e=function(){if(S)return Promise.resolve(k(M,S)).then(function(t){M=t})}();return e&&e.then?e.then(r):r()},a=e.protocol,u=e.tokenID,c=e.utxos,f=e.inputTokens,d=e.distributions,l=e.paymentPk,h=e.ordPk,v=e.satsPerKb,g=void 0===v?p:v,w=e.metaData,S=e.signer,x=e.decimals,I=e.additionalPayments,B=void 0===I?[]:I,T=e.burn,O=void 0!==T&&T,E=e.tokenInputMode,A=void 0===E?exports.TokenInputMode.Needed:E,N=e.splitConfig,K=void 0===N?{outputs:1,omitMetaData:!1}:N;if(!f.every(function(t){return t.id===u}))throw new Error("Input tokens do not match the provided tokenID");var U,j,L=0n,R=0n,D=d.reduce(function(t,e){return t+r.toTokenSat(e.tokens,x,r.ReturnTypes.BigInt)},0n),F=new t.SatoshisPerKilobyte(g),M=new t.Transaction;if(A===exports.TokenInputMode.All)j=f,L=f.reduce(function(t,r){return t+BigInt(r.amt)},0n);else{j=[];for(var V,J=i(f);!(V=J()).done;){var X=V.value;if(j.push(X),(L+=BigInt(X.amt))>=D)break}if(L<D)throw new Error("Not enough tokens to satisfy the transfer amount")}for(var W,G=i(j);!(W=G()).done;){var Y=W.value,Q=Y.pk||h;if(!Q)throw new Error("Private key required for token input");var $=t.Utils.toArray(Y.script,"base64"),z=t.Script.fromBinary($);M.addInput(b(Y,(new y).unlock(Q,"all",!0,Y.satoshis,z)))}if(w)for(var Z=0,tt=Object.keys(w);Z<tt.length;Z++){var rt=tt[Z];void 0===w[rt]&&delete w[rt]}for(var et,nt=i(d);!(et=nt()).done;){var ot=et.value,it=r.toTokenSat(ot.tokens,x,r.ReturnTypes.BigInt);console.log({distTokenSat:it});var st={p:"bsv-20",op:O?"burn":"transfer",amt:it.toString()},at=void 0;if(a===exports.TokenType.BSV20)at=s({},st,{tick:u});else{if(a!==exports.TokenType.BSV21)throw new Error("Invalid protocol");at=s({},st,{id:u})}var ut={dataB64:Buffer.from(JSON.stringify(at)).toString("base64"),contentType:"application/bsv-20"},ct="string"==typeof ot.address?(new y).lock(ot.address,ut,ot.omitMetaData?void 0:P(w)):m(ot.address,ut);M.addOutput({satoshis:1,lockingScript:ct}),R+=it}if((U=L-R)<0n)throw new Error("Not enough tokens to send");var ft,dt=[];if(U>0n){var lt=e.tokenChangeAddress||(null==h?void 0:h.toAddress());if(!lt)throw new Error("ordPk or changeAddress required for token change");dt=function(t,e,n,o,i,a,u,c){var f,d=[],l=void 0!==u.threshold?r.toTokenSat(u.threshold,c,r.ReturnTypes.BigInt):void 0,h=u.outputs,p=e;console.log({splitChangeAmt:p}),void 0!==l&&l>0n?(f=p/l,f=BigInt(Math.min(Number(f),h))):f=BigInt(h);for(var v=p/(f=BigInt(Math.max(Number(f),1))),m=p%f,g=0n;g<f;g++){var w=v;m>0n&&(w+=1n,m-=1n);var b={p:"bsv-20",op:"transfer",amt:w.toString()},k=void 0;if(n===exports.TokenType.BSV20)k=s({},b,{tick:o});else{if(n!==exports.TokenType.BSV21)throw new Error("Invalid protocol");k=s({},b,{id:o})}var S=(new y).lock(i,{dataB64:Buffer.from(JSON.stringify(k)).toString("base64"),contentType:"application/bsv-20"},u.omitMetaData?void 0:P(a)),x=t.outputs.length;t.addOutput({lockingScript:S,satoshis:1}),d.push({id:o,satoshis:1,script:Buffer.from(S.toBinary()).toString("base64"),txid:"",vout:x,amt:w.toString()})}return d}(M,U,a,u,lt,w,K,x)}for(var ht,pt=i(B);!(ht=pt()).done;){var vt=ht.value;M.addOutput({satoshis:vt.amount,lockingScript:(new t.P2PKH).lock(vt.to)})}var yt=e.changeAddress||(null==l?void 0:l.toAddress());if(!yt)throw new Error("paymentPk or changeAddress required for payment change");var mt=(new t.P2PKH).lock(yt);M.addOutput({lockingScript:mt,change:!0});var gt=0n,wt=M.outputs.reduce(function(t,r){return t+BigInt(r.satoshis||0)},0n),bt=0,kt=function(t,r,e){if("function"==typeof t[q]){var n,o,i,s=function(t){try{for(;!((n=a.next()).done||e&&e());)if((t=r(n.value))&&t.then){if(!C(t))return void t.then(s,i||(i=H.bind(null,o=new _,2)));t=t.v}o?H(o,1,t):o=t}catch(t){H(o||(o=new _),2,t)}},a=t[q]();if(s(),a.return){var u=function(t){try{n.done||a.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],f=0;f<t.length;f++)c.push(t[f]);return function(t,r,e){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!e||!e());)if((a=r(i))&&a.then){if(!C(a))return void a.then(s,o||(o=H.bind(null,n=new _,2)));a=a.v}n?H(n,1,a):n=a}catch(t){H(n||(n=new _),2,t)}}(),n}(c,function(t){return r(c[t])},e)}(c,function(r){var e=r.pk||l;if(!e)throw new Error("paymentPk required for payment utxo");var o=b(r,(new t.P2PKH).unlock(e,"all",!0,r.satoshis,t.Script.fromBinary(t.Utils.toArray(r.script,"base64"))));return M.addInput(o),gt+=BigInt(r.satoshis),Promise.resolve(F.computeFee(M)).then(function(t){bt=t,gt>=wt+BigInt(bt)&&(n=1)})},function(){return n||void 0});return Promise.resolve(kt&&kt.then?kt.then(o):o())}catch(t){return Promise.reject(t)}},exports.validateSubTypeData=function(t,r){try{if("collection"===t){var e=r;if(!e.description)return new Error("Collection description is required");if(!e.quantity)return new Error("Collection quantity is required");if(e.rarityLabels){if(!Array.isArray(e.rarityLabels))return new Error("Rarity labels must be an array");if(!e.rarityLabels.every(function(t){return Object.values(t).every(function(t){return"string"==typeof t})}))return new Error("Invalid rarity labels "+e.rarityLabels)}if(e.traits){if("object"!=typeof e.traits)return new Error("Collection traits must be an object");if(e.traits&&!Object.keys(e.traits).every(function(t){return"string"==typeof t&&"object"==typeof e.traits[t]}))return new Error("Collection traits must be a valid CollectionTraits object")}}if("collectionItem"===t){var n=r;if(!n.collectionId)return new Error("Collection id is required");if(!n.collectionId.includes("_"))return new Error("Collection id must be a valid outpoint");if(64!==n.collectionId.split("_")[0].length)return new Error("Collection id must contain a valid txid");if(Number.isNaN(Number.parseInt(n.collectionId.split("_")[1])))return new Error("Collection id must contain a valid vout");if(n.mintNumber&&"number"!=typeof n.mintNumber)return new Error("Mint number must be a number");if(n.rank&&"number"!=typeof n.rank)return new Error("Rank must be a number");if(n.rarityLabel&&"string"!=typeof n.rarityLabel)return new Error("Rarity label must be a string");if(n.traits&&"object"!=typeof n.traits)return new Error("Traits must be an object");if(n.attachments&&!Array.isArray(n.attachments))return new Error("Attachments must be an array")}return}catch(t){return new Error("Invalid JSON data")}};
//# sourceMappingURL=index.cjs.map
